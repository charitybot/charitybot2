{% extends 'layout.html' %}
{% block title %}
    Charitybot2 Event Status Console
{% endblock %}

{% block nocache %}
    <!-- Disable nocache by emptying the block -->
{% endblock %}

{% block extrahead %}
    <meta http-equiv="refresh" content="30" />
{% endblock %}

{% block js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/ui.js') }}"></script>
    <script src="{{ url_for('static', filename='js/stats_console.js') }}"></script>
{% endblock %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/spinner.css') }}">
{% endblock %}

{% block body %}
    <div class="container-fluid">
        <div class="sk-rotating-plane" id="loader"></div>
        <div class="row text-center">
            <h1>Charitybot Event Statistics Console</h1>
        </div>
        <!-- Event Details -->
        <h1 class="text-center">Event: <span id="event_name">{{ event_name }}</span></h1>
        <div class="row text-center">
            <div class="col-md-2 col-md-offset-2">
                Start Time: <span id="event-start"></span>
            </div>
            <div class="col-md-2">
                End Time: <span id="event-end"></span>
            </div>
            <div class="col-md-2">
                Duration: <span id="event-length"></span> hours
            </div>
            <div class="col-md-2">
                Time Remaining: <span id="event-remaining"></span> hours
            </div>
        </div>
        <div class="row text-center">
            <div class="col-md-6 col-md-offset-3 ">
                <div class="progress">
                    <div id="event-progress" class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 60%;"></div>
                </div>
            </div>
        </div>
        <div class="row text-center">
            <div class="col-md-2 col-md-offset-4">
                Amount Raised: <span class="currency-symbol"></span><span id="amount-raised"></span>
            </div>
            <div class="col-md-2">
                Target Amount: <span class="currency-symbol"></span><span id="target-amount"></span>
            </div>
        </div>
        <div class="row text-center">
            <div class="col-md-6 col-md-offset-3 ">
                <div class="progress">
                    <div id="amount-progress" class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
        <div class="row donation-text">
            <div class="col-md-6 col-md-offset-3 text-center">
                <div class="col-md-4 info-row">
                    Amount Raised: <span class="currency_symbol"></span><span id="amount_raised"></span>
                </div>
                <div class="col-md-4 info-row">
                    <span id="last_hour_donation_count"></span> donations in the last hour
                </div>
                <div class="col-md-4 info-row">
                    Last donation: <span class="currency_symbol"></span><span id="last_donation"></span>
                </div>
            </div>
        </div>
        <div class="row donation-text">
            <div class="col-md-6 col-md-offset-3 text-center">
                <div class="col-md-4">
                    <span id="donation_count"></span> donations so far
                </div>
                <div class="col-md-4">
                    Average donation: <span class="currency_symbol"></span><span id="donation_average"></span>
                </div>
                <div class="col-md-4">
                    Largest donation: <span class="currency_symbol"></span><span id="largest_donation"></span>
                </div>
            </div>
        </div>
        <div class="row info-row">
            <div class="col-md-6">
            </div>
        </div>
        <div class="row info-row">
            <div class="col-md-6">
                <canvas id="amountRaisedChart"></canvas>
            </div>
            <div class="col-md-6">
                <canvas id="amountDistributionChart"></canvas>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <button class="btn" onclick="switchMode()">Switch to test mode</button>
            </div>
        </div>
    </div>
{% endblock %}
{% block afterbody %}
    <script>
        var api;
        var test_mode = {{ debug_mode }};
        console.log('Test mode: ' + test_mode);
        var api_url = 'http://www.charitybot.net/'
        var test_url = 'http://127.0.0.1:8000/'

        function switchMode() {
            test_mode = !test_mode;
            console.log('Test mode: ' + test_mode);
            var new_url;
            if (test_mode) {
                new_url = test_url;
            } else {
                new_url = api_url;
            }
            new_url += 'api/v1/';
            api = new API(new_url, "{{ event_name }}");
            api.makeApiCalls();
        }

        $(document).ready(() => {
            api = new API(test_url + 'api/v1/', "{{ event_name }}");
            api.makeApiCalls();
            console.log('Refreshing in 30 seconds');
        });
    </script>
{% endblock %}
